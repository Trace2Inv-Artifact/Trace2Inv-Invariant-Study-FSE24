// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.17;

import {SpokeConnector} from "../../contracts/messaging/connectors/SpokeConnector.sol";
import {ChainBatchHeader, ChainInclusionProof, L2MessageInclusionProof} from "../../contracts/messaging/interfaces/ambs/optimism-v0/IStateCommitmentChain.sol";
import {OptimismV0HubConnector, IStateCommitmentChain} from "../../contracts/messaging/connectors/optimism-v0/OptimismV0HubConnector.sol";
import {OptimismV0HubConnector} from "../../contracts/messaging/connectors/optimism-v0/OptimismV0HubConnector.sol";

import {RootManager, ProposedOwnable} from "../../contracts/messaging/RootManager.sol";

import "../utils/ForgeHelper.sol";

contract MetisHubConnectorForkTest is ForgeHelper {
  // ============ libraries
  using stdStorage for StdStorage;

  // ============ mainnet staging contracts
  OptimismV0HubConnector METIS_HUB_CONNECTOR =
    OptimismV0HubConnector(payable(0x5FA89ea322708b30882D3aa3a9fC3DA4775274c0));
  RootManager ROOT_MANAGER = RootManager(0x0031d290B8526e2Eb6ac22111E5fF96EcA760258);
  address METIS_SPOKE_CONNECTOR = address(0x20098c6d481225fF5D9b2ca84cF68FC683e21031);

  // ============ domains
  uint32 METIS_DOMAIN = 1835365481;
  uint32 ETH_DOMAIN = 6648936;

  // ============ Storage ============
  address watcher = 0x43DB577bB3DD02989Dc3DC8e65E61a27d6914386;
  address owner;

  // ============ Setup ============
  function setUp() public {
    vm.createSelectFork("", 19094479);
    owner = ROOT_MANAGER.owner();
  }

  function test_MetisHubConnector__processMessageFromRoot_works() public {
    // // processMessageFromRoot data for the following L2 -> L1 message:
    // // https://explorer.metis.io/tx/0xbd2be1245ebd1de4724907fc91a2301aac79086aca2c9dafa9150163efb704d6

    ChainBatchHeader memory _stateRootBatchHeader = ChainBatchHeader(
      0x5373,
      bytes32(0x2ba547afb30776f0ea0da45fccb0412c7f58ef3e0120da3a0da71129052abcc8),
      0x0df3,
      0xb111e0,
      bytes(
        hex"0000000000000000000000000000000000000000000000000000000065b13beb0000000000000000000000009cb01d516d930ef49591a05b09e0d33e6286689d"
      )
    );

    bytes32[] memory siblings = new bytes32[](12);
    siblings[0] = bytes32(0xc8473531336c2672e49d09c5e393ca1c395f21db1ace98d6691cb790465215a5);
    siblings[1] = bytes32(0x3c6afe7b0e55fa4addde33f3d7acda4ef6383c3f946c1fbd031070a9e4b33963);
    siblings[2] = bytes32(0x550bd5bf64becf3162aedec4d5fe4efc14010e2e27bd76041eab9136f21c35a3);
    siblings[3] = bytes32(0x56483b32d60f6eb779ea5552c04518344a8e6dd0196160ab7539c7c85ab598b4);
    siblings[4] = bytes32(0x089d480cba8900d97c2626a2aec7b89db6343844353a54958a5b424da04c0e78);
    siblings[5] = bytes32(0xe1676264274ca89bee53bff3e5e7dcd931cb49e48c09446d1a21c1f061cf51a5);
    siblings[6] = bytes32(0xf7927506e0793db4caf060b999bcaa6f59b259b2317e0f7bcbc35ec714c3cfae);
    siblings[7] = bytes32(0x3fcdd5e74d17adecdf6a36980e9fa4c530bec442bd086064ca8ee84225a8b9a8);
    siblings[8] = bytes32(0x8146cedb088f79575655916ffb0170d66e9fd3151126d0a64a5f78fc00c987ec);
    siblings[9] = bytes32(0x7663f27c4ec212e215fbc5f1ff6fe134d8c4c450b4aec35c9642196df6cc1a08);
    siblings[10] = bytes32(0xaf3583fa53bd67ae95344dca07662f066db5b57384605a31ccf7c117d21a425e);
    siblings[11] = bytes32(0x593c274e0c9820b1e12470fb7dfee1f6ba1f660a17a46f4954b40cdc67809dc9);
    ChainInclusionProof memory _stateRootProof = ChainInclusionProof(1680, siblings);

    L2MessageInclusionProof memory _proof = L2MessageInclusionProof(
      bytes32(0xa83714a7cff71a8584be3b49f630ecf678595607882607f74cbdfc2f754721ca),
      _stateRootBatchHeader,
      _stateRootProof,
      bytes(
        hex"f90a31b90214f90211a04035b46611a33d93fc11a41a0e4058e7af9bc690c458b8fec5230ff2d47413d9a0863636c11567a719bc3f64338e5c0bf39cfddfd3cf1be72aa15070a90bd5dd4aa0c5534d04e57c20f0eddbb7d5ae14083fd3c40cf288f384af1a3e3b1982059a3ca0a1bba404e28c33bb05f475f22fac63fe52c3cc64156b252a510d5e968e00ab3fa03383a4d7d0f41e1e0b5f61df256a401844dd865aa82a56732b84535e1566d4aba074bde7317ed6d383f88a3dac581e916a770db4be03b6575da7674c581fb63376a0ff3dc1b878197cba3f90245b43667c1918c4d45ae00d03fbe5728f32ba2b5ec7a031974b333b5777da996e8d3b4ab722807381edf9cf7e806e18753b53cdc766c0a0577355e1bfebae97543ae9b02273cd09a3a4f205f0a0c7ee76176282b232fec9a05bd433fb5571f774f4c8ba3fce5dcf5282acae6a26e20d712f7dc40a951ddb4aa0b6cedc9d61888b1d2542d25dd4e8931de06804a74356fa7b5acaaf0e664ae326a0e642ba69c8a1e75632bd59616cd7c9fba1ba459479271beee040a5923fe58deea0f1ddc5c1fda91a59fe3670aeed77ee78ec3635c1a7f72382f0f9116668c7f90fa0433688bdc64e3899be7eb8ba38eeaa3c8c574a4b6d997eb723251d0f803dd7a7a07794dc537a68f9d67e7ecdcc8207f16bc51ac035ca95df9b346ed87f72b85aaba0be7cc2388f4d97fd36996e8b408bf011c3a73826077854837e10450276723fa880b90214f90211a00c63592103822604db443dc9d65ffd6e1647e0587e1d15d5e6ed155b61f272dea0be7bb4467b2a69389905897c27926df4dc66141bf3cb1e2e202da331bc43d77aa0a1b19f0c23798749cd0a484b7c67ab0a517c27f631f04cb849591bb3c73c4a34a09ff189ebf59737aa29819251b30b355964e90ef5f82d6fb9ca11f59cb075f54da000a5f92cd8b3600a7e6bf19afbb99e033a8922d62fca7f4fbf50e46e5ae64760a01a850516cf431c18185ceec01f22a5dbb1aa994437bdb543704af2779cca9044a053a695af12c733f1246357b96e255055bc8a04719d901627aa2f1618d632cfa8a0394bbfb0bdb1d9cf2128650c06cfef02f94a946a72e43a5d404602ebce59f5b8a05d6c6bc9de3e1880bc9fff6ab0d3c0db0a3d08adb06bb7e260c755475765c383a0793fb6d1e54004dbe672f471fc863750eb12035f5f026c971b8bc5e356917ba1a001c153e3a0f36af7e17a7b686ca9190930a1de5abd8f2bc8856724a2cdbc0beaa045786af861d1c4034a435502a4ad5aed03617afa8b302999015a6cbf80725eb9a026d97cd7d466c96240cfcfe67f0eb1646566e9de504543643eaec4c94b59f0c3a015c6eb70f6e72df6f0f74694df27009430845c43c8743b78dfd1adc6ca63e9d2a07923861a83e731ac61f99a3e8fb2e2f357d37dc8887ad7ebf0be987ccdd1c727a0e2e5dbeea1a6d728756aca13365d4a29c4e7f5b77e0ce65ec2bf7c514277b8a280b90214f90211a0479685d51362936ff08e9306d385d29f77a46c8e760d397e74e3d65bbf941c56a0957c9dbe91d7fc8e12e8d08d752977676b3aac98556b346a84d804d7d5d4f17aa01bff4021cfc1d874b0e63b5d9a8e84ad73929906b29e1c575a2b33b8d8e382d0a0c1aad7876cd95c5753ba90c935a6c14cdd5564def7c370fd2153d4d716023a51a012564f5029e2c66efb7cec0391dcaf2707cdb593d638be302bdd6ca1c02e3bbea02f62bac9a1b223920e6d76336ef768120c30275ac23f8e2399f384eae4a15413a0f0e7f26a1c508946c0adcb0a8a4b8a39887a582171c01c5ad1b0b58bc2c7906da04517fb8bf8f8721fe70abb65bccd821da1cff14ae332a1693850973784b59210a031f1619ea29c320d42cfe839def8b1caf4afdcd8f02b7a4c6a36feba54004a71a073f3945a34f1fa1b5db98dc0c0737101e3d976efc9777862930a0c4e6af37b2fa023a3822a17bdbf2140ffd81040bfece88ea571180ebb594815b67746117b8540a0fdea69fc2b35702c13da70ff43fee7eac47cea7dd6fe6cccb5c1cc3c175f0aa3a03fe5523fcd56c523f116b5b94da76ba291631666655cc09669d757a52cc1ef0ca0c65ede93d310265875ddf782f5bd35af9b038ba9d1674374846f5483d4dcb8bba0bbc27e669ca4bca51237e5ee30efc493419c3072afc08c46cae9999b8f1c1d74a071f88771c23053c91c6e32111e89974b310cf7ea812ed4321c0743604922492580b90214f90211a0b7d5a6e2f7d699883bf2464ca2b7aa2929170aad6a57d3e4991da09903a4f1a6a0aa711df48d32a40676f35b9d4ce8f78fd85c53b22d6765438ac59a5207ffb388a081f9909555d87b29ba4c1fc6e1ecde022af14a8aa012653b8599aace85200813a08106522e959eabe6fa37c0ce5a3856419d57e192d988fc801ef27ea7e3271a16a05732671397d98ca4e33ee36a3d0206bf4665aad01739ac25432719e298b67b80a04812b113c3a70e833bc04af3932978489206dfb77e3b3739148d45b09cf48a72a0584b5a5d6a59b52a56f2f06a403148cdd54588ba24324eb88044d51c58f61edba0674ddbe6421b8dc6f268e3e96b507ff864d7cc2c9ae69b3c85a2b5dda01c1061a05a60ccf57ac1f3846935800466c459e9da67d74e23e97ec3f458729f71b27c77a0b9655a259d37833006c9da122d2d60acde289a40f986faedba18c8d6af6c556ba03ec3a6e1e4f194632cf0731dcde3b677070928d1b745c13468d1fbf1ec5e9cd7a08c86ea7908ac54e8baa341ec3a0c9ea93c42635aeca97e54f2749e9b90ce7776a036b28d27d1611cacfe16efe79ca3ac64f24a18b5ab25526119d5f7225ed47e83a064088fe0d04c70e371f103624d2cd49dac3f59baec12053fc58c20506b0b2d9ea09916534fad83ecf9cb6196e2cbb709acf37d34478aacf078bfb8ee771df80a39a00a42f271a51b8c2a3498105b9bcddb96af849936616268fd733e15bd2e7fd2ae80b8d3f8d1808080a0345a0eaf87571d234daf80d0ed492cd9d875260fbe29f5342e1560856532bf8480a01ded78d0891b4b8eba36c94f0ad19fb338843b7c4b33a57a5608925b6777561d8080a0ae401d6d80bf24728dcc48b774a725631255c7ffd56cde5e740f4b2189ec116f8080a03bd886d51533f88508e63bca6345dcca1fae9360928f8f81c168d2ba07cc5a1da074ef8624c3817b1376ca90e8443b6fc0154e11c062e2d9c07fcb314575f9a600a06b91aeed54a88679ddcecb47435d065a9b1c6fb693f2a49ea4ea59adb58a57eb808080b893f89180a0f311ff662afc6141c3641b0663c773e13d076f396baec3cc1adb48972019b990808080808080a089874609c57c923079d805deec21020d0ac69cc9c81934d386a36590e6e170898080a0f5c5b41ccc9dd0cc807f34066d8b24db8b8792e9aa3265babf706bddbd794728808080a0038401c2593fc1000ab75a22f10f8587d9b7d8f20b7b079f216c524681bf834b80b869f8679e201b46a2440f3eaf346b6c1ce588ed08712591822a258c5a1c4cf44cd0c9b846f8448080a037300e44f2ad7c15f4b6daf8ab96978b83910417d06a73174f07f69fc131ee0ca091fb40f83717ed27e3e76c22af38ca5d7053c6c44010dd452ac75d45c97131fa"
      ),
      bytes(
        hex"f90628b90214f90211a04d856d50c7c12282eaa8071f6ecffde70cb9b0c3b1493f9c2bf64c6cc05b8ce0a04576b132e7b04a09da596348aca4978135be57e020cd367ee7fcdaaaa68deb2ba02401963fc168fe216bae2e7b73dacb071c592e6a92aa777f19c208e3b3bbe874a096bf871c6675d02efaef2a5f616904ee9639419595a2fc77d5731aa8129b4ed6a0edcc77a64f3a7595166841c22f6fff698b6d5f2dfa3c97b6c9f895e8d55f42d5a04a299d6a7a3354585329e1b063796409304435522147b091b55b2784a65f39c0a04cba4f4bd4a4279345f8c67aa0300f1212c1d437e8d569586347a1c77551e0a0a04c3daf749b693deb6ecc73623055642777c7627996cba2433cb39b6b45b2886ba0cd99dea413c720a6b3a24d58826b9fb4e6056e9251d6d8897a7e4b0920257ce7a0a217146abf766e5c3b5712300ec2fefa3179b6567ebfd6e93c7cde5ef148936ca056fabc9371c1245332f062e851193fad8e64462f12dbbc875c55abb96cf840f6a06b43c29094615790e4f6099ff8827c15ab6875132236ffc5e245799acf8defe1a09d35089585540701db447df86d41c71166112ad076b39fc9f63a2be836572f7aa08218e8f2ab75ee9c3a09e9e1f2e67285b09e4651910dd2d99dd31ce92255ab50a06ed94d40300c31085eebda92cd28cb9c3f86456cc4a4a9df1d0215f3a3bb71afa090c879b50a6b789da55220efa7617c0c91a098792f0aedabeae8696b325fae1780b90214f90211a03dd8b50b2cf6f10a0e7efa8f8619db9b80c6708c47612c2d57e73fee2cc03b1ea0a4faccf5ad4aba357a44c572195daaddbc6d8233de27e39ddf6c7bbc95e6447ea05bc615e064c19d7762f828092b05290f3927fe033bf5e03e5c92f52699cba0cba0641ca830530a7a5ee1d31f317b5de3e15de2e118cd65c3bad5aaaac1273f78e3a0d2abb8a5adff02f750fbf1af18823384f82aa4f8ea831e69bb78a8153f5b8446a0fb38100a6aca0dc3b8afddb6d6cc5107fbb734cae46a2cedca3871f73e37dffda01f513db4b90e3489381550a992cc9776389a599ccd7de7b273b059251c1d96a0a0c6af65417748dce3ec431ce0626c79fce951e665b5567f727457f37a85654af6a0191e8fa20a78f058cad16313da7124ea89901186eeed8332033b8ec1f5c7f62ea0f54ebda7a363d93ce62d5e437a90382c82494c7a471dd358e4ec9a6754fbbb1aa07da1e518d7be6a358eb538598393188ce9144264136f9e1eb66018ab4beb582ba03b44ddf9952cdd8f8e7d2da3e43433c5125bdb0d20dc845eab29c994a9866be8a01661d166c45c5b2a477b2f038cfbfe160e8198d3b5ccf0a68abc9db2b84cecc5a06782eedc5107f28a8b7d37158121eb29e638d8ff7dd6a192ba5a9cdebbfe05c5a09eb3bb400a01348b3bf75182e67ca3d4499dcc219e5ad09a53c6f3a0b1b3f937a02312b4fb2899fcd63e11e73122f6f13bbbcbef6d85a153c08bc50f142b512c1080b901d4f901d1a00e739a3e3baaeba91bf4bf9980b95acb140eca2fa838e576b99f220ed27afec9a09a5ff17045439663e9517d5f910f605c84b6a645fd770fc5da828128fd211bbaa04886b84c7eb3666468b05a341e22c5f7bfab11b98fe5a94fb595423a744ef13ba040bb52a5af7c6e0a8bcde71bdef71a0bf09ca29b9903019f33b42d396b97f983a070f54e90c22962287854ad11b2a0e1f966ce8e93b87408130d75467f6583ce34a07398f50b7e53524b4886f64f7ab43663125f422591e97edca9b2118a44a74ef5a0070557fc5d0eb2d659c9511a3acfd9c6c1d9ac56442ea59811f7fcb7284838caa01cbb271eea8eabe94771b53a3a5a396e9e890ba38cf5c168c44c1fb91b72d7b7a083847b0f491ec0743cffa14bd1db3f30e053ec347a074c9b7ded28a810c5757ea09183228b7f63b6721b2e73ee8d9f2d7cb845f5df53cd80440b6ae0fe8f1a9b9380a0af2aa833a182f0a5d9c912791d2b7a85926db8b3f5f0d867404a84280c9ed20980a0d79daa9ae679d3c8a301f516b0d45df36df0280758dbe0e8ea5347701700a24aa075d53d2e79efe5b8736cd52c9d06be1e3c9fe7c1b30bba515754d8baab842cf3a00b4e7fdecdfecfbd2132e26fec48445bf4bb11e8261735f23700a8f0478bc4ea80a2e19f359ece4be6e95c47b797739485f32d1994d5add49f3ddf072d8d94eacaa14601"
      )
    );

    address _target = address(0x3980c9ed79d2c191A89E02Fa3529C60eD6e9c04b);
    address _sender = address(0x4200000000000000000000000000000000000010);
    bytes
      memory _message = hex"90a40a7600000000000000000000000000000000000000000000000000000000000004400000000000000000000000009897258904e0a1ec600a9780f1211538013257a40000000000000000000000009897258904e0a1ec600a9780f1211538013257a40000000000000000000000000000000000000000000000018b84570022a2000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000";
    uint256 _messageNonce = 106603;

    // sanity check: message is verified
    bool verified = IStateCommitmentChain(address(0xf209815E595Cdf3ed0aAF9665b1772e608AB9380)).verifyStateCommitment(
      _proof.stateRoot,
      _proof.stateRootBatchHeader,
      _proof.stateRootProof
    );
    assertTrue(verified, "!verified");

    // update existing hub connector with new encoding
    OptimismV0HubConnector noXsender = new OptimismV0HubConnector(
      ETH_DOMAIN,
      METIS_DOMAIN,
      address(0x20098c6d481225fF5D9b2ca84cF68FC683e21031), // mirror connector
      address(ROOT_MANAGER),
      METIS_SPOKE_CONNECTOR,
      address(0xf209815E595Cdf3ed0aAF9665b1772e608AB9380), // state commitment chain
      1231231231231231
    );

    vm.etch(address(METIS_HUB_CONNECTOR), address(noXsender).code);

    assertTrue(METIS_HUB_CONNECTOR.processed(bytes32(_message)) == false, "processed");
    OptimismV0HubConnector(payable(address(METIS_HUB_CONNECTOR))).processMessageFromRoot(
      _target,
      _sender,
      _message,
      _messageNonce,
      _proof
    );
    assertTrue(METIS_HUB_CONNECTOR.processed(bytes32(_message)), "!processed");
  }
}
